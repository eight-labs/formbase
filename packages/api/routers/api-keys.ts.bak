import { TRPCError } from '@trpc/server';
import { and, desc, eq, gte } from 'drizzle-orm';
import { z } from 'zod';

import { drizzlePrimitives } from '@formbase/db';
import { apiAuditLogs, apiKeys } from '@formbase/db/schema';
import { generateId } from '@formbase/utils/generate-id';

import { generateApiKey, hashApiKey } from '../lib/api-key';
import { createRouter, protectedProcedure } from '../trpc';

export const apiKeysRouter = createRouter({
  list: protectedProcedure.query(async ({ ctx }) => {
    const keys = await ctx.db.query.apiKeys.findMany({
      where: (table) => eq(table.userId, ctx.user.id),
      orderBy: (table) => desc(table.createdAt),
    });
    return keys;
  }),

  create: protectedProcedure
    .input(
      z.object({
        name: z.string().min(1).max(100),
        expiresAt: z.date().optional(),
      }),
    )
    .mutation(async ({ ctx, input }) => {
      const { key, prefix, hash } = generateApiKey();

      await ctx.db.insert(apiKeys).values({
        id: generateId(15),
        userId: ctx.user.id,
        name: input.name,
        keyHash: hash,
        keyPrefix: prefix,
        expiresAt: input.expiresAt ?? null,
      });

      return { key };
    }),

  delete: protectedProcedure
    .input(z.object({ id: z.string() }))
    .mutation(async ({ ctx, input }) => {
      const apiKey = await ctx.db.query.apiKeys.findFirst({
        where: (table) =>
          and(eq(table.id, input.id), eq(table.userId, ctx.user.id)),
      });

      if (!apiKey) {
        throw new TRPCError({ code: 'NOT_FOUND', message: 'API key not found' });
      }

      await ctx.db
        .delete(apiKeys)
        .where(drizzlePrimitives.eq(apiKeys.id, input.id));
    }),

  getUsageStats: protectedProcedure
    .input(z.object({ id: z.string() }))
    .query(async ({ ctx, input }) => {
      const apiKey = await ctx.db.query.apiKeys.findFirst({
        where: (table) =>
          and(eq(table.id, input.id), eq(table.userId, ctx.user.id)),
      });

      if (!apiKey) {
        throw new TRPCError({ code: 'NOT_FOUND', message: 'API key not found' });
      }

      const now = new Date();
      const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);

      const [totalResult, last24hResult] = await Promise.all([
        ctx.db
          .select({ count: drizzlePrimitives.count() })
          .from(apiAuditLogs)
          .where(eq(apiAuditLogs.apiKeyId, input.id)),
        ctx.db
          .select({ count: drizzlePrimitives.count() })
          .from(apiAuditLogs)
          .where(
            and(
              eq(apiAuditLogs.apiKeyId, input.id),
              gte(apiAuditLogs.createdAt, last24h),
            ),
          ),
      ]);

      return {
        total: totalResult[0]?.count ?? 0,
        last24h: last24hResult[0]?.count ?? 0,
      };
    }),
});
